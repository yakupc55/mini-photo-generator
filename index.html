<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mamba VX | Debug & Prompt Edition</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.2/dist/ort.all.min.js"></script>
    <script type="module">
        import * as fflate from 'https://cdn.skypack.dev/fflate?min';
        window.fflate = fflate;
    </script>

    <style>
        :root { --primary: #00ff88; --bg: #0a0a0c; --card: #15151a; --accent: #007bff; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; }
        
        .layout { display: grid; grid-template-columns: 1fr 320px; gap: 15px; max-width: 1200px; margin: auto; }
        @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }

        .panel { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid #2a2a2e; }

        /* HazÄ±r Promptlar Paneli */
        .prompt-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 15px; max-height: 200px; overflow-y: auto; padding-right: 5px; }
        .prompt-chip { background: #222; border: 1px solid #333; padding: 8px; border-radius: 8px; font-size: 11px; cursor: pointer; text-align: center; transition: 0.2s; }
        .prompt-chip:hover { border-color: var(--primary); background: #2a2a2a; }

        /* GÃ¶rsel AlanÄ± */
        .canvas-container { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 15px; overflow: hidden; margin-bottom: 15px; }
        canvas { width: 100%; height: 100%; image-rendering: pixelated; }

        /* Progress ve Log */
        .overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; }
        #log-screen { background: #000; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; border-radius: 10px; height: 120px; overflow-y: auto; border: 1px solid #333; margin-top: 10px; }

        /* Form ElemanlarÄ± */
        input { width: 100%; background: #000; border: 1px solid #333; padding: 15px; border-radius: 12px; color: #fff; box-sizing: border-box; margin-bottom: 10px; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        .btn-gen { background: var(--accent); color: white; }
        .btn-log { background: #333; color: #ccc; font-size: 11px; }

        .progress-bar { width: 80%; height: 4px; background: #222; border-radius: 2px; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.3s; }
        
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .modal img { max-width: 95%; border-radius: 10px; }
    </style>
</head>
<body>

<div class="layout">
    <div class="panel">
        <h3 style="margin:0 0 10px 0">ðŸŽ¨ Ãœretim Paneli</h3>
        
        <div class="canvas-container">
            <canvas id="mainCanvas" onclick="openModal()"></canvas>
            <div id="loader" class="overlay">
                <span id="status-txt" style="font-size: 12px;">BEKLENÄ°YOR...</span>
                <div class="progress-bar"><div id="p-fill" class="progress-fill"></div></div>
            </div>
        </div>

        <input type="text" id="promptIn" placeholder="Buraya yazÄ±n veya aÅŸaÄŸÄ±dan seÃ§in...">
        <button class="btn btn-gen" id="genBtn" onclick="generate()" disabled>GÃ–RSELÄ° ÃœRET</button>
        
        <h4>ðŸš€ HazÄ±r Promptlar</h4>
        <div class="prompt-grid" id="promptGrid"></div>
    </div>

    <div class="panel">
        <h3 style="margin:0 0 10px 0">ðŸ›  Sistem & Log</h3>
        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">
            Motor: <span id="st-engine" style="color:var(--primary)">YÃ¼kleniyor...</span><br>
            HÄ±z: <span id="st-time" style="color:var(--primary)">0 ms</span>
        </div>
        
        <div id="log-screen">--- Sistem LoglarÄ± Bekleniyor (Mobil Hata Takibi) ---</div>
        <button class="btn btn-log" style="margin-top:10px" onclick="clearLog()">LoglarÄ± Temizle</button>
        <button class="btn btn-log" onclick="downloadImg()">ðŸ’¾ GÃ¶rseli Kaydet</button>
        
        <div style="margin-top:20px; background:#111; padding:10px; border-radius:10px; font-size:11px; color:#666;">
            <b>Gri Ekran HatasÄ± Ä°Ã§in:</b> Loglarda "GPU" veya "Buffer" hatasÄ± gÃ¶rÃ¼yorsanÄ±z, WebGPU mobil uyumlu deÄŸildir. Otomatik CPU'ya geÃ§iÅŸ yapÄ±lacaktÄ±r.
        </div>
    </div>
</div>

<div id="imgModal" class="modal" onclick="this.style.display='none'"><img id="modalImg"></div>

<script>
    const promptLibrary = [
        "kÄ±rmÄ±zÄ± araba", "yeÅŸil araba", "sarÄ± araba", "siyah bina", "gri bina", "yeÅŸil bina", "sarÄ± bina",
        "aslan", "banyo", "oÄŸlan", "cami", "kÃ¶peks", "dondurma", "eyfel kulesi", "balÄ±k", "kÄ±z", "karÄ±nca",
        "kedi", "mutfak", "adam", "daÄŸ", "oturma odasÄ±", "uzay", "kalabalÄ±k cadde", "kadÄ±n", "dÃ¼nya"
    ];

    let sess, wordToId, embTable, imgDim, embSize, ctx, rawImg;
    let currentEngine = 'webgpu';

    function log(msg) {
        const screen = document.getElementById('log-screen');
        screen.innerHTML += `<br>> ${msg}`;
        screen.scrollTop = screen.scrollHeight;
        console.log(msg);
    }

    function clearLog() { document.getElementById('log-screen').innerHTML = "> Loglar temizlendi."; }

    // PromptlarÄ± Ekrana Bas
    const grid = document.getElementById('promptGrid');
    promptLibrary.forEach(p => {
        const div = document.createElement('div');
        div.className = 'prompt-chip';
        div.innerText = p;
        div.onclick = () => document.getElementById('promptIn').value = p;
        grid.appendChild(div);
    });

    ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.2/dist/';
    ort.env.wasm.numThreads = navigator.hardwareConcurrency || 4;

    window.onload = async () => {
        log("Sistem baÅŸlatÄ±ldÄ±. Model aranÄ±yor...");
        try {
            const res = await fetch('main.mambax');
            const blob = await res.blob();
            const buf = await blob.arrayBuffer();
            const dv = new DataView(buf);
            
            imgDim = dv.getUint32(8, true);
            embSize = dv.getUint32(12, true);
            const jL = dv.getUint32(16, true);
            wordToId = JSON.parse(new TextDecoder().decode(buf.slice(20, 20 + jL)));
            
            let off = 20 + jL;
            const eL = dv.getUint32(off, true);
            const eComp = new Uint8Array(buf.slice(off+4, off+4+eL));
            const oComp = new Uint8Array(buf.slice(off+4+eL));

            fflate.decompress(eComp, (err, d1) => {
                embTable = new Float32Array(d1.buffer);
                fflate.decompress(oComp, async (err, d2) => {
                    window.modelData = d2;
                    await initEngine('webgpu');
                    setupCanvas();
                });
            });
        } catch(e) { log("Kritik Hata: " + e.message); }
    };

    async function initEngine(mode) {
        log(`${mode.toUpperCase()} motoru yÃ¼kleniyor...`);
        try {
            const opts = mode === 'webgpu' ? { executionProviders: ['webgpu'] } : { executionProviders: ['wasm'], intraOpNumThreads: ort.env.wasm.numThreads };
            sess = await ort.InferenceSession.create(window.modelData, opts);
            currentEngine = mode;
            document.getElementById('st-engine').innerText = mode.toUpperCase();
            document.getElementById('genBtn').disabled = false;
            log("Motor hazÄ±r.");
        } catch(e) {
            log("Motor HatasÄ±: " + e.message);
            if(mode === 'webgpu') {
                log("GPU BaÅŸarÄ±sÄ±z. CPU'ya geÃ§iliyor...");
                initEngine('wasm');
            }
        }
    }

    function setupCanvas() {
        const c = document.getElementById('mainCanvas');
        c.width = c.height = imgDim;
        ctx = c.getContext('2d', { alpha: false });
        rawImg = ctx.createImageData(imgDim, imgDim);
        log(`Canvas hazÄ±r: ${imgDim}x${imgDim}`);
    }

    async function generate() {
        const loader = document.getElementById('loader');
        const pFill = document.getElementById('p-fill');
        const status = document.getElementById('status-txt');
        
        loader.style.display = 'flex';
        pFill.style.width = '10%';
        
        const rawP = document.getElementById('promptIn').value;
        const prompt = rawP.toLocaleLowerCase('tr-TR').split(/\s+/);
        log(`Prompt iÅŸleniyor: ${rawP}`);

        const input = new Float32Array(32 * embSize);
        for(let i=0; i<32; i++) {
            const id = wordToId[prompt[i] || "<|pad|>"] || 0;
            input.set(embTable.subarray(id * embSize, (id * embSize) + embSize), i * embSize);
        }

        pFill.style.width = '40%';
        status.innerText = "HESAPLANIYOR...";

        const t0 = performance.now();
        try {
            const res = await sess.run({ input: new ort.Tensor('float32', input, [1, 32, embSize]) });
            log("Hesaplama bitti. Veri okunuyor...");
            
            pFill.style.width = '70%';
            const out = await res.output.getData(); 
            
            if(!out || out[0] === undefined) throw new Error("GPU boÅŸ veri dÃ¶ndÃ¼ (Gri Ekran)");

            const pix = rawImg.data;
            const area = imgDim * imgDim;
            let r=0, g=area, b=area*2, p=0;
            for(let i=0; i<area; i++) {
                pix[p++] = (out[r++] + 1) * 127.5;
                pix[p++] = (out[g++] + 1) * 127.5;
                pix[p++] = (out[b++] + 1) * 127.5;
                pix[p++] = 255;
            }
            ctx.putImageData(rawImg, 0, 0);
            
            pFill.style.width = '100%';
            document.getElementById('st-time').innerText = Math.round(performance.now() - t0) + " ms";
            log("GÃ¶rsel baÅŸarÄ±yla oluÅŸturuldu.");
        } catch(e) {
            log("Ãœretim HatasÄ±: " + e.message);
            alert("Hata: " + e.message + ". Sayfa CPU moduna alÄ±nabilir.");
        }
        
        setTimeout(() => loader.style.display = 'none', 500);
    }

    function openModal() {
        document.getElementById('modalImg').src = document.getElementById('mainCanvas').toDataURL();
        document.getElementById('imgModal').style.display = 'flex';
    }

    function downloadImg() {
        const a = document.createElement('a');
        a.download = 'mamba_out.png';
        a.href = document.getElementById('mainCanvas').toDataURL();
        a.click();
    }
</script>
</body>
</html>