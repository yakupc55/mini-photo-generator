<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mamba VX | Hard-Sync Edition</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.2/dist/ort.all.min.js"></script>
    <script type="module">
        import * as fflate from 'https://cdn.skypack.dev/fflate?min';
        window.fflate = fflate;
    </script>

    <style>
        :root { --primary: #00ff88; --bg: #050508; --card: #111116; --accent: #007bff; }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Inter', sans-serif; margin: 0; padding: 10px; }
        .layout { max-width: 1000px; margin: auto; display: grid; grid-template-columns: 1fr 340px; gap: 15px; }
        @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
        .panel { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid #222; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .canvas-area { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 16px; overflow: hidden; border: 2px solid #1a1a1a; margin-bottom: 15px; }
        canvas { width: 100%; height: 100%; image-rendering: pixelated; display: block; }
        .prompt-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; max-height: 180px; overflow-y: auto; margin-top: 15px; padding: 5px; background: rgba(0,0,0,0.3); border-radius: 12px; }
        .chip { background: #1a1a1f; border: 1px solid #333; padding: 10px; border-radius: 10px; font-size: 11px; cursor: pointer; text-align: center; color: #aaa; transition: 0.2s; }
        .chip:hover { border-color: var(--primary); color: #fff; }
        input { width: 100%; background: #000; border: 1px solid #333; padding: 16px; border-radius: 14px; color: #fff; box-sizing: border-box; font-size: 16px; margin-bottom: 12px; }
        .btn-gen { width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: 800; cursor: pointer; background: var(--accent); color: #fff; letter-spacing: 1px; }
        .btn-gen:disabled { opacity: 0.3; }
        .overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 5; }
        .loader-bar { width: 60%; height: 4px; background: #222; border-radius: 2px; margin-top: 12px; overflow: hidden; }
        .loader-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; box-shadow: 0 0 10px var(--primary); }
    </style>
</head>
<body>

<div class="layout">
    <div class="panel">
        <div class="canvas-area">
            <canvas id="mainCanvas"></canvas>
            <div id="loader" class="overlay">
                <b id="status-txt" style="color:var(--primary); font-size:14px;">BEKLEYÄ°N...</b>
                <div class="loader-bar"><div id="p-fill" class="loader-fill"></div></div>
            </div>
        </div>

        <input type="text" id="promptIn" placeholder="Bir prompt seÃ§in veya yazÄ±n...">
        <button class="btn-gen" id="genBtn" onclick="generate()" disabled>GÃ–RSELÄ° ÃœRET</button>

        <div class="prompt-grid" id="pGrid"></div>
    </div>

    <div class="panel">
        <h3 style="margin:0 0 15px 0; font-size:16px;">SÄ°STEM DURUMU</h3>
        <div style="font-size:12px; line-height:2;">
            Mod: <span id="st-engine" style="color:var(--primary)">YÃ¼kleniyor...</span><br>
            Performans: <span id="st-time" style="color:var(--primary)">0 ms</span><br>
            Durum: <span id="st-debug" style="color:var(--accent)">Sistem HazÄ±r</span>
        </div>
        <hr style="border:0; border-top:1px solid #222; margin:15px 0;">
        <button onclick="downloadImg()" style="width:100%; padding:12px; border-radius:10px; background:#1a1a1f; border:1px solid #333; color:#fff; cursor:pointer;">ðŸ’¾ RESMÄ° KAYDET</button>
        <p style="font-size:10px; color:#555; margin-top:15px;">EÄŸer hala gri ekran alÄ±yorsanÄ±z, tarayÄ±cÄ±nÄ±z GPU belleÄŸini JS'ye aktarmÄ±yor demektir. Bu durumda ekranÄ± yenileyip bir kez daha deneyin.</p>
    </div>
</div>

<script>
    const prompts = [
        "kÄ±rmÄ±zÄ± araba", "yeÅŸil araba", "sarÄ± araba", "siyah bina", "gri bina", "yeÅŸil bina", "sarÄ± bina",
        "aslan", "banyo", "oÄŸlan", "cami", "kÃ¶pek", "dondurma", "eyfel kulesi", "balÄ±k", "kÄ±z", "karÄ±nca",
        "kedi", "mutfak", "adam", "daÄŸ", "oturma odasÄ±", "uzay", "kalabalÄ±k cadde", "kadÄ±n", "dÃ¼nya"
    ];

    let sess, wordToId, embTable, imgDim, embSize, ctx, rawImg;

    // Prompt Grid OluÅŸtur
    const grid = document.getElementById('pGrid');
    prompts.forEach(p => {
        const div = document.createElement('div');
        div.className = 'chip';
        div.innerText = p;
        div.onclick = () => document.getElementById('promptIn').value = p;
        grid.appendChild(div);
    });

    ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.2/dist/';
    
    window.onload = async () => {
        try {
            const res = await fetch('main.mambax');
            const blob = await res.blob();
            const buf = await blob.arrayBuffer();
            const dv = new DataView(buf);
            
            imgDim = dv.getUint32(8, true);
            embSize = dv.getUint32(12, true);
            const jL = dv.getUint32(16, true);
            wordToId = JSON.parse(new TextDecoder().decode(buf.slice(20, 20 + jL)));
            
            let off = 20 + jL;
            const eL = dv.getUint32(off, true);
            const eComp = new Uint8Array(buf.slice(off+4, off+4+eL));
            const oComp = new Uint8Array(buf.slice(off+4+eL));

            fflate.decompress(eComp, (err, d1) => {
                embTable = new Float32Array(d1.buffer);
                fflate.decompress(oComp, async (err, d2) => {
                    window.modelData = d2;
                    await initEngine();
                    setupCanvas();
                });
            });
        } catch(e) { document.getElementById('st-debug').innerText = "Hata: Model bulunamadÄ±."; }
    };

    async function initEngine() {
        try {
            // WebGPU ile baÅŸla, hata alÄ±rsan WASM'a geÃ§
            sess = await ort.InferenceSession.create(window.modelData, { executionProviders: ['webgpu'] });
            document.getElementById('st-engine').innerText = "GPU (WebGPU)";
        } catch(e) {
            sess = await ort.InferenceSession.create(window.modelData, { executionProviders: ['wasm'], intraOpNumThreads: 4 });
            document.getElementById('st-engine').innerText = "CPU (WASM)";
        }
        document.getElementById('genBtn').disabled = false;
    }

    function setupCanvas() {
        const c = document.getElementById('mainCanvas');
        c.width = c.height = imgDim;
        ctx = c.getContext('2d', { alpha: false, desynchronized: true });
        rawImg = ctx.createImageData(imgDim, imgDim);
    }

    async function generate() {
        const loader = document.getElementById('loader');
        const pFill = document.getElementById('p-fill');
        const status = document.getElementById('status-txt');
        
        loader.style.display = 'flex';
        pFill.style.width = '10%';
        status.innerText = "Ä°ÅžLENÄ°YOR...";

        const prompt = document.getElementById('promptIn').value.toLocaleLowerCase('tr-TR').split(/\s+/);
        const input = new Float32Array(32 * embSize);
        for(let i=0; i<32; i++) {
            const id = wordToId[prompt[i] || "<|pad|>"] || 0;
            input.set(embTable.subarray(id * embSize, (id * embSize) + embSize), i * embSize);
        }

        pFill.style.width = '40%';
        const t0 = performance.now();

        try {
            const results = await sess.run({ input: new ort.Tensor('float32', input, [1, 32, embSize]) });
            
            pFill.style.width = '70%';
            status.innerText = "SENKRONÄ°ZE EDÄ°LÄ°YOR...";

            // --- KRÄ°TÄ°K MOBÄ°L FIX ---
            // BazÄ± mobil tarayÄ±cÄ±lar (Ã¶zellikle Safari/Chrome) GPU sonuÃ§larÄ±nÄ± anÄ±nda JS'ye vermez.
            // KÃ¼Ã§Ã¼k bir bekleme (micro-task) ekleyerek GPU'nun buffer'Ä± boÅŸaltmasÄ±na izin veriyoruz.
            await new Promise(r => setTimeout(r, 100)); 
            
            const out = await results.output.getData(); 
            
            // EÄŸer hala 0 dÃ¶nÃ¼yorsa ikinci bir inatÃ§Ä± deneme yapÄ±yoruz
            if(out[0] === 0 && out[100] === 0) {
                 await new Promise(r => setTimeout(r, 300));
            }

            const pix = rawImg.data;
            const area = imgDim * imgDim;
            let r=0, g=area, b=area*2, p=0;
            
            for(let i=0; i<area; i++) {
                pix[p++] = (out[r++] + 1) * 127.5;
                pix[p++] = (out[g++] + 1) * 127.5;
                pix[p++] = (out[b++] + 1) * 127.5;
                pix[p++] = 255;
            }
            
            ctx.putImageData(rawImg, 0, 0);
            pFill.style.width = '100%';
            document.getElementById('st-time').innerText = Math.round(performance.now() - t0) + " ms";
            document.getElementById('st-debug').innerText = "GÃ¶rsel Ã‡izildi";
        } catch(e) {
            document.getElementById('st-debug').innerText = "Hata: " + e.message;
        }
        
        setTimeout(() => loader.style.display = 'none', 600);
    }

    function downloadImg() {
        const link = document.createElement('a');
        link.download = `mamba_${Date.now()}.png`;
        link.href = document.getElementById('mainCanvas').toDataURL('image/png');
        link.click();
    }
</script>
</body>
</html>