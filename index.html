<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mamba VX | Neural Engine</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.2/dist/ort.all.min.js"></script>
    <script type="module">
        import * as fflate from 'https://cdn.skypack.dev/fflate?min';
        window.fflate = fflate;
    </script>

    <style>
        :root {
            --primary: #00ff88;
            --accent: #00d9ff;
            --bg: #0b0b0e;
            --glass: rgba(22, 22, 28, 0.95);
            --border: rgba(255, 255, 255, 0.12);
            --text-main: #ffffff;
            --text-dim: #a0a0a8;
        }

        html, body { 
            background: var(--bg); color: var(--text-main); 
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif; 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; touch-action: manipulation;
            -webkit-font-smoothing: antialiased;
        }

        /* Başlangıç Yükleme Ekranı */
        #splash-screen {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 5000; transition: opacity 0.5s;
        }

        /* TÜM EKRAN KARARMA PANELİ */
        #full-proc-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.92);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 4000; backdrop-filter: blur(12px);
        }

        .app-shell {
            width: 100%; max-width: 1200px; padding: 20px;
            display: grid; grid-template-columns: 1fr 360px; gap: 24px;
            height: 100vh; box-sizing: border-box; align-items: center; margin: auto;
        }

        @media (max-width: 900px) { 
            .app-shell { grid-template-columns: 1fr; overflow-y: auto; display: block; padding-top: 60px; } 
        }

        .glass-card {
            background: var(--glass); backdrop-filter: blur(30px);
            border: 1px solid var(--border); border-radius: 28px;
            padding: 30px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); margin-bottom: 20px;
        }

        .canvas-container {
            width: 100%; aspect-ratio: 1/1; background: #000; 
            border-radius: 20px; overflow: hidden; border: 1px solid #1a1a1e;
            box-shadow: inset 0 0 20px rgba(0,0,0,1);
        }

        canvas { width: 100%; height: 100%; image-rendering: pixelated; }

        input {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            padding: 20px; border-radius: 16px; color: #fff; font-size: 17px;
            margin-top: 24px; box-sizing: border-box; outline: none; transition: border 0.3s;
            font-weight: 400;
        }
        input:focus { border-color: var(--primary); }

        .btn-gen {
            width: 100%; margin-top: 18px; padding: 22px; border-radius: 16px;
            border: none; background: var(--primary); color: #000;
            font-weight: 800; text-transform: uppercase; cursor: pointer; 
            letter-spacing: 1.5px; font-size: 15px; transition: transform 0.1s, opacity 0.2s;
        }
        .btn-gen:active { transform: scale(0.98); }

        .btn-gen:disabled { background: #222 !important; color: #555 !important; pointer-events: none !important; }

        .chips { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
            gap: 10px; margin-top: 20px; max-height: 150px; overflow-y: auto; padding-right: 5px;
        }
        .chips::-webkit-scrollbar { width: 4px; }
        .chips::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .chip { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--border); 
            padding: 12px 8px; border-radius: 12px; font-size: 13px; color: var(--text-dim); 
            cursor: pointer; text-align: center; transition: all 0.2s;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .chip:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.3); }

        .stat-card { 
            background: rgba(0,0,0,0.2); padding: 18px; border-radius: 18px; 
            margin-bottom: 12px; display: flex; justify-content: space-between; 
            font-size: 13px; border: 1px solid var(--border); letter-spacing: 0.5px;
        }
        .stat-card span:first-child { color: var(--text-dim); font-weight: 600; }
        .stat-card span:last-child { color: var(--primary); font-weight: 700; font-family: monospace; font-size: 14px; }

        .loader-bar { width: 220px; height: 6px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-top: 20px; overflow: hidden; }
        .loader-progress { width: 0%; height: 100%; background: var(--primary); box-shadow: 0 0 20px var(--primary); transition: width 0.3s; }
        
        .save-btn {
            width: 100%; padding: 16px; border-radius: 14px; background: transparent; 
            border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; 
            font-size: 12px; margin-top: 10px; font-weight: 600; transition: all 0.2s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .save-btn:hover { background: rgba(255,255,255,0.05); color: #fff; border-color: #444; }
    </style>
</head>
<body>

<div id="splash-screen">
    <div style="font-weight: 900; letter-spacing: 10px; color: var(--primary); font-size: 24px; margin-bottom: 5px;">MAMBA</div>
    <div style="font-size: 12px; color: #555; letter-spacing: 2px; margin-bottom: 20px;">NEURAL ENGINE SYSTEM</div>
    <div class="loader-bar"><div id="splash-bar" class="loader-progress"></div></div>
</div>

<div id="full-proc-overlay">
    <div style="letter-spacing: 5px; font-size: 16px; font-weight: 800; color: var(--primary); text-transform: uppercase;">Resim İşleniyor</div>
    <div class="loader-bar"><div id="proc-bar" class="loader-progress"></div></div>
    <div id="perc-txt" style="font-size: 14px; margin-top: 15px; color: var(--text-dim); font-family: monospace;">0%</div>
</div>

<div class="app-shell">
    <div class="glass-card">
        <div class="canvas-container"><canvas id="mainCanvas"></canvas></div>
        <input type="text" id="promptIn" placeholder="Hayalinizdeki temayı yazın..." autocomplete="off">
        <button id="genBtn" class="btn-gen" onclick="generate()" disabled>Oluşturmayı Başlat</button>
        <div class="chips" id="chipGrid"></div>
    </div>
    <div class="glass-card" style="display: flex; flex-direction: column; justify-content: center;">
        <div style="font-size: 11px; color: #555; font-weight: 800; margin-bottom: 15px; letter-spacing: 1px; text-transform: uppercase;">Sistem Durumu</div>
        <div class="stat-card"><span>MOTOR</span><span id="st-engine">HAZIRLANIYOR</span></div>
        <div class="stat-card"><span>HIZ</span><span id="st-time">0 ms</span></div>
        <button class="save-btn" onclick="downloadImg()">Görseli Cihaza Kaydet</button>
    </div>
</div>

<script>
    const prompts = ["kırmızı araba", "yeşil araba", "sarı araba", "siyah bina", "gri bina", "yeşil bina", "sarı bina", "aslan", "banyo", "oğlan", "cami", "köpek", "dondurma", "eyfel kulesi", "balık", "kız", "karınca", "kedi", "mutfak", "adam", "dağ", "oturma odası", "uzay", "kalabalık cadde", "kadın", "dünya"];
    let sess, wordToId, embTable, imgDim, embSize, ctx, rawImg;

    const grid = document.getElementById('chipGrid');
    prompts.forEach(p => {
        const d = document.createElement('div');
        d.className = 'chip'; d.innerText = p;
        d.onclick = () => document.getElementById('promptIn').value = p;
        grid.appendChild(d);
    });

    ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.2/dist/';

    window.onload = async () => {
        const sBar = document.getElementById('splash-bar');
        try {
            const res = await fetch('main.mambax');
            const buf = await res.arrayBuffer();
            const dv = new DataView(buf);
            imgDim = dv.getUint32(8, true);
            embSize = dv.getUint32(12, true);
            const jL = dv.getUint32(16, true);
            wordToId = JSON.parse(new TextDecoder().decode(buf.slice(20, 20 + jL)));
            let off = 20 + jL;
            const eL = dv.getUint32(off, true);
            const eComp = new Uint8Array(buf.slice(off+4, off+4+eL));
            const oComp = new Uint8Array(buf.slice(off+4+eL));

            fflate.decompress(eComp, (err, d1) => {
                embTable = new Float32Array(d1.buffer);
                fflate.decompress(oComp, async (err, d2) => {
                    window.modelData = d2;
                    await initEngine();
                    setupCanvas();
                    sBar.style.width = '100%';
                    setTimeout(() => {
                        document.getElementById('splash-screen').style.opacity = '0';
                        setTimeout(() => document.getElementById('splash-screen').remove(), 500);
                    }, 400);
                });
            });
        } catch(e) { console.error(e); }
    };

    async function initEngine() {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const mode = isMobile ? 'wasm' : 'webgpu';
        try {
            sess = await ort.InferenceSession.create(window.modelData, { executionProviders: [mode], intraOpNumThreads: 4 });
            document.getElementById('st-engine').innerText = mode.toUpperCase();
        } catch(e) {
            sess = await ort.InferenceSession.create(window.modelData, { executionProviders: ['wasm'] });
            document.getElementById('st-engine').innerText = "WASM";
        }
        document.getElementById('genBtn').disabled = false;
    }

    function setupCanvas() {
        const c = document.getElementById('mainCanvas');
        c.width = c.height = imgDim;
        ctx = c.getContext('2d', { alpha: false });
        rawImg = ctx.createImageData(imgDim, imgDim);
    }

    async function generate() {
        const btn = document.getElementById('genBtn');
        const overlay = document.getElementById('full-proc-overlay');
        const bar = document.getElementById('proc-bar');
        const perc = document.getElementById('perc-txt');
        
        btn.disabled = true;
        overlay.style.display = 'flex';
        bar.style.width = '5%';
        perc.innerText = "5%";

        await new Promise(resolve => setTimeout(resolve, 50));

        const prompt = document.getElementById('promptIn').value.toLocaleLowerCase('tr-TR').split(/\s+/);
        const input = new Float32Array(32 * embSize);
        for(let i=0; i<32; i++) {
            const id = wordToId[prompt[i] || "<|pad|>"] || 0;
            input.set(embTable.subarray(id * embSize, (id * embSize) + embSize), i * embSize);
        }

        const t0 = performance.now();
        try {
            const res = await sess.run({ input: new ort.Tensor('float32', input, [1, 32, embSize]) });
            const out = await res.output.getData(); 
            const pix = rawImg.data;
            const area = imgDim * imgDim;
            let r=0, g=area, b=area*2, p=0;
            for(let i=0; i<area; i++) {
                pix[p++] = (out[r++] + 1) * 127.5;
                pix[p++] = (out[g++] + 1) * 127.5;
                pix[p++] = (out[b++] + 1) * 127.5;
                pix[p++] = 255;
            }
            ctx.putImageData(rawImg, 0, 0);
            document.getElementById('st-time').innerText = Math.round(performance.now() - t0) + " ms";
            bar.style.width = '100%';
            perc.innerText = "100%";
        } catch(e) { console.error(e); }

        setTimeout(() => { 
            overlay.style.display = 'none'; 
            btn.disabled = false;
        }, 300);
    }

    function downloadImg() {
        const a = document.createElement('a');
        a.download = 'mamba_output.png';
        a.href = document.getElementById('mainCanvas').toDataURL('image/png');
        a.click();
    }
</script>
</body>
</html>