<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mamba VX | Ultimate AI Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.2/dist/ort.all.min.js"></script>
    <script type="module">
        import * as fflate from 'https://cdn.skypack.dev/fflate?min';
        window.fflate = fflate;
    </script>
    <style>
        :root { --accent: #00ff88; --bg: #0a0a0c; --card: #141417; --text: #e0e0e0; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, -apple-system, sans-serif; margin: 0; padding: 10px; display: flex; justify-content: center; min-height: 100vh; }
        
        .container { width: 100%; max-width: 1100px; display: grid; grid-template-columns: 1fr 350px; gap: 15px; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

        .main-card, .side-card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid #2a2a2e; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* Resim Ã–nizleme */
        .preview-box { background: #000; border-radius: 12px; overflow: hidden; position: relative; margin-bottom: 15px; aspect-ratio: 1/1; cursor: zoom-in; display: flex; align-items: center; justify-content: center; border: 1px solid #333; transition: 0.3s; }
        .preview-box:hover { border-color: var(--accent); }
        canvas { width: 100%; height: 100%; image-rendering: pixelated; }

        /* Kontrol Paneli */
        .controls { display: flex; flex-direction: column; gap: 10px; }
        .input-row { display: flex; gap: 8px; }
        input { flex: 1; background: #000; border: 1px solid #3a3a3e; color: #fff; padding: 14px; border-radius: 10px; outline: none; font-size: 16px; }
        input:focus { border-color: var(--accent); }
        
        button { background: #007bff; color: white; border: none; padding: 14px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #0069d9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #2a2a2e; border: 1px solid #444; }

        /* Motor SeÃ§ici (GPU/CPU) */
        .engine-selector { display: flex; gap: 5px; background: #000; padding: 5px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #222; }
        .engine-opt { flex: 1; text-align: center; padding: 10px; border-radius: 8px; font-size: 13px; cursor: pointer; transition: 0.3s; color: #666; font-weight: 600; }
        .engine-opt.active { background: #1a1a1a; color: var(--accent); border: 1px solid rgba(0,255,136,0.3); }

        /* Modal (BÃ¼yÃ¼tme Penceresi) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 9999; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { max-width: 100%; max-height: 100%; position: relative; display: flex; flex-direction: column; align-items: center; }
        .modal-content img { max-width: 95vw; max-height: 80vh; border-radius: 12px; box-shadow: 0 0 50px rgba(0,0,0,1), 0 0 20px var(--accent); border: 1px solid #444; }
        .close-modal { position: absolute; top: -50px; right: 0; color: #fff; font-size: 40px; cursor: pointer; }

        /* Ä°statistikler */
        .stat-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; font-size: 13px; }
        .stat-val { color: var(--accent); font-family: 'JetBrains Mono', monospace; font-weight: bold; }
        h3 { margin: 0 0 15px 0; font-size: 18px; color: #fff; letter-spacing: 1px; }

        /* YÃ¼kleme EkranÄ± */
        #loader-txt { position: absolute; font-size: 14px; color: #555; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <div class="engine-selector">
            <div id="opt-webgpu" class="engine-opt active" onclick="switchEngine('webgpu')">GPU (Turbo)</div>
            <div id="opt-wasm" class="engine-opt" onclick="switchEngine('wasm')">CPU (GÃ¼venli)</div>
        </div>

        <div class="preview-box" onclick="openModal()" title="BÃ¼yÃ¼tmek iÃ§in tÄ±klayÄ±n">
            <canvas id="mainCanvas"></canvas>
            <div id="loader-txt">Model YÃ¼kleniyor...</div>
        </div>

        <div class="controls">
            <div class="input-row">
                <input type="text" id="promptIn" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n (Ã¶rn: Galaxy)..." autocomplete="off">
                <button id="genBtn" onclick="generate()" disabled>ÃœRET</button>
            </div>
            <button class="btn-secondary" onclick="downloadImage()">ðŸ’¾ GÃ¶rseli Ä°ndir</button>
        </div>
    </div>

    <div class="side-card">
        <h3>ðŸ“Š Sistem Raporu</h3>
        <div class="stat-item"><span>DonanÄ±m Modu</span><span class="stat-val" id="st-engine">-</span></div>
        <div class="stat-item"><span>Hesaplama SÃ¼resi</span><span class="stat-val" id="st-time">0 ms</span></div>
        <div class="stat-item"><span>Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k</span><span class="stat-val" id="st-res">-</span></div>
        <div class="stat-item"><span>Ä°ÅŸlemci Ä°zole</span><span class="stat-val" id="st-iso">-</span></div>
        <div class="stat-item"><span>Ã‡ekirdek SayÄ±sÄ±</span><span class="stat-val" id="st-threads">-</span></div>
        
        <div style="margin-top: 20px; padding: 12px; background: #000; border-radius: 10px; font-size: 11px; color: #777; line-height: 1.5;">
            <b>Bilgi:</b> GiriÅŸler otomatik olarak kÃ¼Ã§Ã¼k harfe Ã§evrilir. Telefonda gri ekran sorunu yaÅŸarsanÄ±z <b>CPU</b> moduna geÃ§in.
        </div>
    </div>
</div>

<div id="imgModal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal">&times;</span>
        <img id="modalImg" src="" alt="Mamba Output High Res">
        <p style="color: #888; margin-top: 15px;">Kapatmak iÃ§in dÄ±ÅŸarÄ±ya tÄ±klayÄ±n</p>
    </div>
</div>

<script>
    let sess, wordToId, embTable, imgDim, embSize, ctx, rawImg;
    let currentProvider = 'webgpu';
    const MAX_LEN = 32;

    // Ortam AyarlarÄ±
    ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.2/dist/';
    ort.env.wasm.numThreads = navigator.hardwareConcurrency || 4;

    window.onload = async () => {
        document.getElementById('st-iso').innerText = window.crossOriginIsolated ? "AKTÄ°F" : "PASÄ°F";
        document.getElementById('st-threads').innerText = ort.env.wasm.numThreads;
        
        try {
            const res = await fetch('main.mambax');
            if(!res.ok) throw new Error();
            const blob = await res.blob();
            await initSystem(blob);
        } catch(e) { 
            document.getElementById('loader-txt').innerText = "Model (main.mambax) bulunamadÄ±!"; 
        }
    };

    async function initSystem(blob) {
        const buf = await blob.arrayBuffer();
        const dv = new DataView(buf);
        imgDim = dv.getUint32(8, true);
        embSize = dv.getUint32(12, true);
        const jL = dv.getUint32(16, true);
        wordToId = JSON.parse(new TextDecoder().decode(buf.slice(20, 20 + jL)));
        
        let off = 20 + jL;
        const eL = dv.getUint32(off, true);
        const eComp = new Uint8Array(buf.slice(off+4, off+4+eL));
        const oComp = new Uint8Array(buf.slice(off+4+eL));

        fflate.decompress(eComp, (err, d1) => {
            embTable = new Float32Array(d1.buffer);
            fflate.decompress(oComp, async (err, d2) => {
                window.rawOnnx = d2; 
                await loadSession(currentProvider);
                setupCanvas();
            });
        });
    }

    async function loadSession(provider) {
        document.getElementById('genBtn').disabled = true;
        document.getElementById('st-engine').innerText = "YÃ¼kleniyor...";
        
        try {
            const opts = provider === 'webgpu' ? 
                { executionProviders: ['webgpu'] } : 
                { executionProviders: ['wasm'], intraOpNumThreads: ort.env.wasm.numThreads };
            
            sess = await ort.InferenceSession.create(window.rawOnnx, opts);
            currentProvider = provider;
            
            document.getElementById('st-engine').innerText = provider === 'webgpu' ? "GPU (WebGPU)" : "CPU (WASM)";
            document.getElementById('genBtn').disabled = false;
            document.getElementById('loader-txt').style.display = 'none';
        } catch(e) {
            console.error(e);
            if(provider === 'webgpu') {
                alert("WebGPU bu cihazda baÅŸlatÄ±lamadÄ±. CPU moduna geÃ§iliyor.");
                switchEngine('wasm');
            }
        }
    }

    function switchEngine(type) {
        if(currentProvider === type) return;
        document.querySelectorAll('.engine-opt').forEach(el => el.classList.remove('active'));
        document.getElementById(`opt-${type}`).classList.add('active');
        if(window.rawOnnx) loadSession(type);
    }

    function setupCanvas() {
        const c = document.getElementById('mainCanvas');
        c.width = c.height = imgDim;
        ctx = c.getContext('2d', { alpha: false });
        rawImg = ctx.createImageData(imgDim, imgDim);
        document.getElementById('st-res').innerText = `${imgDim}x${imgDim}`;
    }

    async function generate() {
        const btn = document.getElementById('genBtn');
        btn.innerText = "Ä°ÅŸleniyor...";
        btn.disabled = true;

        // KRÄ°TÄ°K: GiriÅŸi kÃ¼Ã§Ã¼k harflere Ã§evir (TÃ¼rkÃ§e karakter desteÄŸi ile)
        const rawInput = document.getElementById('promptIn').value;
        const prompt = rawInput.toLocaleLowerCase('tr-TR').split(/\s+/);
        
        const inputBuffer = new Float32Array(MAX_LEN * embSize);
        for(let i=0; i<MAX_LEN; i++) {
            const word = prompt[i] || "<|pad|>";
            const id = wordToId[word] || 0;
            inputBuffer.set(embTable.subarray(id * embSize, (id * embSize) + embSize), i * embSize);
        }

        const t0 = performance.now();
        try {
            const res = await sess.run({ input: new ort.Tensor('float32', inputBuffer, [1, MAX_LEN, embSize]) });
            const output = await res.output.getData();
            
            const pix = rawImg.data;
            const area = imgDim * imgDim;
            let r=0, g=area, b=area*2, p=0;
            for(let i=0; i<area; i++) {
                pix[p++] = (output[r++] + 1) * 127.5;
                pix[p++] = (output[g++] + 1) * 127.5;
                pix[p++] = (output[b++] + 1) * 127.5;
                pix[p++] = 255;
            }
            ctx.putImageData(rawImg, 0, 0);
            document.getElementById('st-time').innerText = `${Math.round(performance.now() - t0)} ms`;
        } catch(e) { alert("Hata: " + e.message); }
        
        btn.innerText = "ÃœRET";
        btn.disabled = false;
    }

    // Modal (BÃ¼yÃ¼tme Penceresi) FonksiyonlarÄ±
    function openModal() {
        const modal = document.getElementById('imgModal');
        const mImg = document.getElementById('modalImg');
        // Canvas iÃ§eriÄŸini yÃ¼ksek kaliteli resme dÃ¶nÃ¼ÅŸtÃ¼r
        mImg.src = document.getElementById('mainCanvas').toDataURL('image/png');
        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('imgModal').style.display = 'none';
    }

    function downloadImage() {
        const a = document.createElement('a');
        a.download = `mamba_${Date.now()}.png`;
        a.href = document.getElementById('mainCanvas').toDataURL();
        a.click();
    }
</script>
</body>
</html>