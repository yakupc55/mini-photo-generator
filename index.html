<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mamba VX Pro | AI Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.2/dist/ort.all.min.js"></script>
    <script type="module">
        import * as fflate from 'https://cdn.skypack.dev/fflate?min';
        window.fflate = fflate;
    </script>
    <style>
        :root { --accent: #00ff88; --bg: #0d0d0f; --card: #16161a; --text: #f0f0f0; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        
        .container { width: 100%; max-width: 1000px; display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        @media (max-width: 850px) { .container { grid-template-columns: 1fr; } }

        .main-card { background: var(--card); border-radius: 24px; padding: 25px; border: 1px solid #2a2a2e; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .side-card { background: var(--card); border-radius: 24px; padding: 25px; border: 1px solid #2a2a2e; align-self: start; }

        /* Canvas & Zoom */
        .preview-container { position: relative; width: 100%; background: #000; border-radius: 16px; overflow: hidden; margin-bottom: 20px; cursor: zoom-in; }
        .preview-container:active { cursor: zoom-out; }
        .preview-container:active canvas { transform: scale(1.8); }
        canvas { width: 100%; display: block; image-rendering: pixelated; transition: transform 0.3s ease; transform-origin: center; }

        /* Inputs */
        .input-box { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; background: #000; border: 1px solid #3a3a3e; color: #fff; padding: 14px; border-radius: 12px; outline: none; font-size: 16px; }
        input:focus { border-color: var(--accent); }
        
        button { background: #007bff; color: #fff; border: none; padding: 14px 25px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:hover { background: #0056b3; transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .secondary-btn { background: #2a2a2e; width: 100%; margin-top: 10px; }

        /* Stats */
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .badge { padding: 5px 12px; border-radius: 30px; font-size: 12px; font-weight: bold; background: #222; border: 1px solid #444; }
        .badge.active { color: var(--accent); border-color: var(--accent); }
        
        .stat-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; font-size: 14px; }
        .stat-val { color: var(--accent); font-family: monospace; }
        h2 { margin: 0 0 15px 0; font-size: 18px; color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <div class="status-header">
            <h2 id="model-name">Mamba Vision Engine</h2>
            <div id="engine-badge" class="badge">BAÅžLATILIYOR...</div>
        </div>

        <div class="preview-container" id="zoomArea">
            <canvas id="outCanvas"></canvas>
        </div>

        <div class="input-box">
            <input type="text" id="promptIn" placeholder="Bir ÅŸeyler hayal et..." autocomplete="off">
            <button id="genBtn" onclick="generate()" disabled>ÃœRET</button>
        </div>
        <button class="secondary-btn" onclick="downloadImg()">â¬‡ GÃ¶rseli PNG Olarak Kaydet</button>
    </div>

    <div class="side-card">
        <h2>ðŸ“Š CanlÄ± Ä°statistikler</h2>
        <div class="stat-item"><span>DonanÄ±m Modu</span><span class="stat-val" id="st-mode">-</span></div>
        <div class="stat-item"><span>Ã‡ekirdek (Threads)</span><span class="stat-val" id="st-threads">-</span></div>
        <div class="stat-item"><span>Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k</span><span class="stat-val" id="st-res">0x0</span></div>
        <div class="stat-item"><span>Model YÃ¼kleme</span><span class="stat-val" id="st-load">Bekliyor</span></div>
        <div class="stat-item"><span>Gecikme</span><span class="stat-val" id="st-time">0 ms</span></div>
        <div class="stat-item"><span>Secure Context</span><span class="stat-val" id="st-iso">-</span></div>

        <div style="margin-top: 25px; font-size: 12px; color: #888; line-height: 1.6;">
            <b>Ä°pucu:</b> GÃ¶rselin Ã¼zerine basÄ±lÄ± tutarak bÃ¼yÃ¼tebilirsiniz. GitHub Pages HTTPS sunduÄŸu iÃ§in WebGPU otomatik aktifleÅŸir.
        </div>
    </div>
</div>

<script>
    let session, words, embeddings, imgSize, dim, ctx, imgData;
    const MAX_S = 32;

    // Ortam ve Multi-thread AyarlarÄ±
    ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.2/dist/';
    ort.env.wasm.numThreads = navigator.hardwareConcurrency || 4;

    window.onload = async () => {
        document.getElementById('st-threads').innerText = ort.env.wasm.numThreads;
        document.getElementById('st-iso').innerText = window.crossOriginIsolated ? "EVET" : "HAYIR";
        
        try {
            document.getElementById('st-load').innerText = "AranÄ±yor...";
            const res = await fetch('main.mambax');
            if(!res.ok) throw new Error();
            const blob = await res.blob();
            await loadModel(blob);
        } catch(e) {
            document.getElementById('st-load').innerText = "HATA";
            alert("main.mambax dosyasÄ± bulunamadÄ±! GitHub repo kÃ¶k dizinine dosyayÄ± eklediÄŸinizden emin olun.");
        }
    };

    async function loadModel(blob) {
        document.getElementById('st-load').innerText = "AyrÄ±ÅŸtÄ±rÄ±lÄ±yor...";
        const buf = await blob.arrayBuffer();
        const dv = new DataView(buf);
        
        imgSize = dv.getUint32(8, true);
        dim = dv.getUint32(12, true);
        const jL = dv.getUint32(16, true);
        words = JSON.parse(new TextDecoder().decode(buf.slice(20, 20 + jL)));
        
        let off = 20 + jL;
        const eL = dv.getUint32(off, true);
        const eC = new Uint8Array(buf.slice(off+4, off+4+eL));
        const oC = new Uint8Array(buf.slice(off+4+eL));

        fflate.decompress(eC, (err, d1) => {
            embeddings = new Float32Array(d1.buffer);
            fflate.decompress(oC, async (err, d2) => {
                try {
                    // Ã–nce WebGPU dene
                    try {
                        session = await ort.InferenceSession.create(d2, { executionProviders: ['webgpu'] });
                        setUI(true);
                    } catch(e) {
                        // Olmazsa Multi-thread WASM
                        session = await ort.InferenceSession.create(d2, { 
                            executionProviders: ['wasm'],
                            intraOpNumThreads: ort.env.wasm.numThreads
                        });
                        setUI(false);
                    }
                } catch(e) { alert("Model baÅŸlatma hatasÄ±."); }
            });
        });
    }

    function setUI(isGpu) {
        const badge = document.getElementById('engine-badge');
        badge.innerText = isGpu ? "WEBGPU AKTÄ°F" : "WASM AKTÄ°F";
        if(isGpu) badge.classList.add('active');
        document.getElementById('st-mode').innerText = isGpu ? "GPU (WebGPU)" : "CPU (WASM)";
        document.getElementById('st-load').innerText = "TAMAM";
        document.getElementById('st-res').innerText = `${imgSize}x${imgSize}`;
        document.getElementById('genBtn').disabled = false;
        
        const c = document.getElementById('outCanvas');
        c.width = c.height = imgSize;
        ctx = c.getContext('2d', { alpha: false });
        imgData = ctx.createImageData(imgSize, imgSize);
    }

    async function generate() {
        const btn = document.getElementById('genBtn');
        btn.disabled = true;
        btn.innerText = "...";
        
        const prompt = document.getElementById('promptIn').value.toLowerCase().split(/\s+/);
        const input = new Float32Array(MAX_S * dim);
        
        for(let i=0; i<MAX_S; i++) {
            const id = words[prompt[i] || "<|pad|>"] || 0;
            input.set(embeddings.subarray(id * dim, (id * dim) + dim), i * dim);
        }

        const t0 = performance.now();
        const res = await session.run({ input: new ort.Tensor('float32', input, [1, MAX_S, dim]) });
        const output = await res.output.getData();
        const t1 = performance.now();

        const pix = imgData.data;
        const area = imgSize * imgSize;
        let r=0, g=area, b=area*2, p=0;
        for(let i=0; i<area; i++) {
            pix[p++] = (output[r++] + 1) * 127.5;
            pix[p++] = (output[g++] + 1) * 127.5;
            pix[p++] = (output[b++] + 1) * 127.5;
            pix[p++] = 255;
        }
        ctx.putImageData(imgData, 0, 0);
        document.getElementById('st-time').innerText = `${Math.round(t1-t0)} ms`;
        btn.disabled = false;
        btn.innerText = "ÃœRET";
    }

    function downloadImg() {
        const a = document.createElement('a');
        a.download = 'mamba-output.png';
        a.href = document.getElementById('outCanvas').toDataURL();
        a.click();
    }
</script>
</body>
</html>